name: Lacework Scans

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      LW_ACCOUNT: ${{ secrets.LW_ACCOUNT_NAME }}
      LW_API_TOKEN: ${{ secrets.LW_ACCESS_TOKEN }}
      REGISTRY: myregistry.example.com
      IMAGE_NAME: myapp
      GHA_SHA: ${{ github.sha }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install Lacework CLI
        run: |
          curl https://raw.githubusercontent.com/lacework/go-sdk/main/cli/install.sh | bash

      - name: Dockerfile IaC scan
        run: |
          lacework code scan --dockerfile ./Dockerfile --upload

      - name: Container image vulnerability scan
        uses: lacework/lw-scanner-action@v1.4.0
        with:
          LW_ACCOUNT_NAME: ${{ secrets.LW_ACCOUNT_NAME }}
          LW_ACCESS_TOKEN: ${{ secrets.LW_ACCESS_TOKEN }}
          IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ env.GHA_SHA }}
          SAVE_RESULTS_IN_LACEWORK: true
          RESULTS_IN_GITHUB_SUMMARY: true

      - name: Change formatting for PR comment
        if: github.event_name == 'pull_request'
        run: |
          echo "# Lacework Inline Scanner Result" > pr-results.md
          echo "<pre>" >> pr-results.md
          cat results.stdout >> pr-results.md
          echo "</pre>" >> pr-results.md

      - name: Comment PR with scan results
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: pr-results.md
